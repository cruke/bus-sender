<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bus Location Sender</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#f5f7fa; color:#111; }
    header { background:#0078ff; color:#fff; padding:10px 16px; font-size:1.1rem; font-weight:600; }
    main { padding:14px; max-width:780px; margin: 0 auto; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    label { font-weight:600; margin-top:10px; display:block; }
    input, select, button {
      width:100%; font-size:1rem; padding:8px 10px; border-radius:8px; border:1px solid #c9d3e0; box-sizing:border-box; margin-top:6px;
      background:#fff;
    }
    button { cursor:pointer; }
    button.primary { background:#0078ff; color:#fff; border:none; }
    button.secondary { background:#eef3f8; color:#111; border:1px solid #c9d3e0; }
    input:disabled, select:disabled, button:disabled { opacity:.6; pointer-events:none; }

    #map { height:360px; border-radius:10px; margin-top:14px; position:relative; overflow:hidden; }

    .status { margin-top:10px; font-size:0.95rem; min-height:1.2em; }
    .ok { color:#137333; } .err { color:#b3261e; }

    .toolbar { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }

    /* Map icons (non-clickable status + map-type switch) */
    .icon-badge {
      position:absolute; bottom:10px; z-index:600;
      width:42px; height:42px; border-radius:50%;
      background:rgba(255,255,255,0.95);
      display:flex; align-items:center; justify-content:center;
      box-shadow:0 2px 6px rgba(0,0,0,.25);
      font-size:20px; border:1px solid #d8dee9;
      user-select:none;
    }
    #wakeIcon { right:10px; pointer-events:none; }
    #mapTypeIcon { left:10px; cursor:pointer; }

    /* Wake colors */
    .wake-on { background:#e6ffea; border-color:#75d08a; }
    .wake-off { background:rgba(255,255,255,0.95); border-color:#d8dee9; }

    /* Toast */
    .toast {
      position:absolute; top:10px; left:50%; transform:translateX(-50%);
      background:rgba(0,0,0,.8); color:#fff; padding:8px 12px; border-radius:10px;
      font-size:.9rem; z-index:650; display:none;
    }

    /* Hide Leaflet/OSM built-in text */
    .leaflet-control-attribution,
    .leaflet-control-scale { display: none !important; }
  </style>
</head>
<body>
  <header>üöå Bus Location Sender</header>
  <main>
    <div class="row">
      <div>
        <label for="busId">Bus ID</label>
        <input type="text" id="busId" placeholder="e.g. 201, 206, 305" />
      </div>
      <div>
        <label for="driver">Driver Name</label>
        <input type="text" id="driver" placeholder="e.g. Najmi" />
      </div>
    </div>

    <div class="row">
      <div>
        <label for="destination">Destination</label>
        <input type="text" id="destination" placeholder="e.g. Kuantan" />
      </div>
      <div>
        <label for="interval">Auto interval (sec)</label>
        <select id="interval">
          <option value="3">3</option>
          <option value="5" selected>5</option>
          <option value="10">10</option>
          <option value="15">15</option>
        </select>
      </div>
    </div>

    <div class="toolbar">
      <button id="btnAuto" class="primary">‚ñ∂Ô∏è Start Auto Update</button>
      <button id="btnClear" class="secondary">üßπ Clear Saved Fields</button>
    </div>

    <div id="map">
      <div id="mapTypeIcon" class="icon-badge" title="Switch Map Type">üó∫Ô∏è</div>
      <div id="wakeIcon" class="icon-badge wake-off" title="Wake Lock status">üí°</div>
      <div id="toast" class="toast"></div>
    </div>

    <div class="status" id="status"></div>
  </main>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // ====== CONFIG ======
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyuInv2pTegro2wfqdMOHX1-dUKq2SY98QpP-Cm5iqFEPmHPd8kHnYv0deGQknViQSM/exec";
    const TRAIL_MAX_POINTS = 1000;

    // ====== DOM ======
    const busIdEl = document.getElementById('busId');
    const driverEl = document.getElementById('driver');
    const destEl   = document.getElementById('destination');
    const intervalEl = document.getElementById('interval');
    const statusDiv = document.getElementById('status');
    const btnAuto = document.getElementById('btnAuto');
    const btnClear = document.getElementById('btnClear');
    const wakeIcon = document.getElementById('wakeIcon');
    const mapTypeIcon = document.getElementById('mapTypeIcon');
    const toastEl = document.getElementById('toast');

    // ====== Local Storage (auto-save fields) ======
    const LS_KEY = 'bus_sender_fields';
    function saveFields() {
      const d = {
        busId: busIdEl.value.trim(),
        driver: driverEl.value.trim(),
        dest: destEl.value.trim(),
        interval: intervalEl.value
      };
      localStorage.setItem(LS_KEY, JSON.stringify(d));
    }
    function loadFields() {
      try {
        const d = JSON.parse(localStorage.getItem(LS_KEY) || '{}');
        if (d.busId) busIdEl.value = d.busId;
        if (d.driver) driverEl.value = d.driver;
        if (d.dest) destEl.value = d.dest;
        if (d.interval) intervalEl.value = d.interval;
      } catch {}
    }
    [busIdEl, driverEl, destEl, intervalEl].forEach(el => el.addEventListener('change', saveFields));
    loadFields();

    // ====== UI helpers ======
    function showStatus(msg, ok=true) {
      statusDiv.textContent = msg;
      statusDiv.className = ok ? 'status ok' : 'status err';
      // toast
      toastEl.textContent = msg;
      toastEl.style.display = 'block';
      clearTimeout(showStatus._t);
      showStatus._t = setTimeout(()=>toastEl.style.display = 'none', 1800);
    }
    function lockForm(lock) {
      [busIdEl, driverEl, destEl, intervalEl, btnClear].forEach(e => e.disabled = lock);
    }

    // ====== Map & Layers ======
    const map = L.map('map', { attributionControl:false }).setView([3.54,103.43], 14);

    // Base layers
    const layers = {
      streets: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}'),
      satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'),
      osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')
    };
    // Label overlay (keeps names visible over satellite too)
    const labelsOverlay = L.tileLayer(
      'https://stamen-tiles.a.ssl.fastly.net/toner-labels/{z}/{x}/{y}.png',
      { opacity: 0.9 }
    );

    // Default: STREET NAMES ON (Esri Streets + labels)
    let baseKey = 'streets';
    layers[baseKey].addTo(map);
    labelsOverlay.addTo(map); // keep labels visible by default

    // Map type switcher cycles: streets -> satellite -> osm
    const baseOrder = ['streets','satellite','osm'];
    function switchMapType() {
      map.removeLayer(layers[baseKey]);
      baseKey = baseOrder[(baseOrder.indexOf(baseKey)+1)%baseOrder.length];
      layers[baseKey].addTo(map);

      // Ensure street names visible: keep labels overlay ON for all bases
      if (!map.hasLayer(labelsOverlay)) labelsOverlay.addTo(map);

      showStatus('Map: ' + baseKey);
    }
    mapTypeIcon.onclick = switchMapType;

    // Bus marker (white circle with bus emoji)
    const busIcon = L.divIcon({
      className: 'bus-icon',
      html: `<div style="width:34px;height:34px;background:white;border-radius:50%;
                      display:flex;align-items:center;justify-content:center;
                      font-size:20px; border:1px solid #dfe3e8;">üöç</div>`,
      iconSize: [34,34],
      iconAnchor: [17,17]
    });
    const marker = L.marker([3.54,103.43], { icon: busIcon }).addTo(map);
    const trail = L.polyline([], { color:'#0078ff', weight:5, opacity:0.85 }).addTo(map);

    function updateTrail(lat, lng) {
      const pts = trail.getLatLngs();
      pts.push([lat, lng]);
      if (pts.length > TRAIL_MAX_POINTS) pts.splice(0, pts.length - TRAIL_MAX_POINTS);
      trail.setLatLngs(pts);
    }

    // ====== Geo & Stats ======
    let watchId = null;
    let lastPos = null;        // {lat,lng,time(ms)}
    let startTime = null;      // ms
    let totalDist = 0;         // meters
    let lastPost = 0;          // ms

    function haversine(lat1, lon1, lat2, lon2) {
      const R=6371000, toRad=x=>x*Math.PI/180;
      const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
      const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    }

    function updateStats(curLat, curLng, curTimeMs) {
      if (!startTime) startTime = curTimeMs;
      let instMps = 0;
      if (lastPos) {
        const d = haversine(lastPos.lat, lastPos.lng, curLat, curLng);
        const dt = (curTimeMs - lastPos.time) / 1000;
        if (dt > 0 && d >= 0) {
          instMps = d / dt;
          totalDist += d;
        }
      }
      lastPos = { lat: curLat, lng: curLng, time: curTimeMs };

      const elapsed = (curTimeMs - startTime) / 1000;      // s
      const avgMps = elapsed > 0 ? (totalDist / elapsed) : 0;
      const kmh = (instMps * 3.6).toFixed(1);
      const avgKmh = (avgMps * 3.6).toFixed(1);
      const distKm = (totalDist / 1000).toFixed(2);

      showStatus(`üöç ${kmh} km/h | Avg ${avgKmh} | Dist ${distKm} km`);
      return instMps;
    }

    async function postUpdate(lat, lng, speedMps) {
      const payload = {
        busId: busIdEl.value.trim(),
        driver: driverEl.value.trim(),
        destination: destEl.value.trim(),
        lat, lng,
        speed_mps: speedMps || 0,
        timestamp: new Date().toISOString()
      };
      if (!payload.busId) return showStatus('Please fill Bus ID', false);
      if (!payload.driver) return showStatus('Please fill Driver Name', false);

      try {
        await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' }, // avoid preflight
          body: JSON.stringify(payload)
        });
      } catch (e) {
        showStatus('Network error: ' + e.message, false);
      }
    }

    // ====== Wake Lock (managed by Start/Stop only) ======
    let wakeLock = null;
    async function acquireWake() {
      try {
        if (!('wakeLock' in navigator)) { showStatus('Wake Lock not supported', false); return; }
        if (wakeLock) return; // already on
        wakeLock = await navigator.wakeLock.request('screen');
        wakeIcon.classList.remove('wake-off'); wakeIcon.classList.add('wake-on'); wakeIcon.textContent = 'üîÜ';
        showStatus('Wake Lock: ON');
        wakeLock.addEventListener('release', () => {
          wakeIcon.classList.remove('wake-on'); wakeIcon.classList.add('wake-off'); wakeIcon.textContent = 'üí°';
          showStatus('Wake Lock released');
        });
        document.addEventListener('visibilitychange', async () => {
          if (wakeLock !== null && document.visibilityState === 'visible') {
            try {
              wakeLock = await navigator.wakeLock.request('screen');
              wakeIcon.classList.remove('wake-off'); wakeIcon.classList.add('wake-on'); wakeIcon.textContent = 'üîÜ';
              showStatus('Wake Lock re-acquired');
            } catch {}
          }
        });
      } catch {
        showStatus('Wake Lock error', false);
      }
    }
    async function releaseWake() {
      if (wakeLock) {
        try { await wakeLock.release(); } catch {}
        wakeLock = null;
      }
      wakeIcon.classList.remove('wake-on'); wakeIcon.classList.add('wake-off'); wakeIcon.textContent = 'üí°';
      // no toast here; Stop button shows its own status
    }

    // ====== Start/Stop tracking ======
    btnAuto.onclick = async () => {
      if (watchId) {
        // Stop
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
        await releaseWake();
        btnAuto.textContent = '‚ñ∂Ô∏è Start Auto Update';
        lockForm(false);
        showStatus('‚è∏Ô∏è Tracking stopped');
        return;
      }

      if (!navigator.geolocation) return showStatus('‚ùå Geolocation not supported', false);

      // Reset stats & trail
      lastPos = null; startTime = null; totalDist = 0; lastPost = 0;
      trail.setLatLngs([]);

      lockForm(true);
      btnAuto.textContent = 'üõë Stop Auto Update';
      showStatus('‚ñ∂Ô∏è Tracking started');

      await acquireWake(); // turn ON when starting

      const minGap = Number(intervalEl.value) * 1000;
      watchId = navigator.geolocation.watchPosition(pos => {
        const { latitude, longitude } = pos.coords;
        const nowMs = pos.timestamp || Date.now();

        // Update map and trail
        marker.setLatLng([latitude, longitude]);
        updateTrail(latitude, longitude);
        map.setView([latitude, longitude]); // auto-follow (keep current zoom)

        // Update stats
        const instMps = updateStats(latitude, longitude, nowMs);

        // Throttle POSTs
        if (!lastPost || (Date.now() - lastPost) >= minGap) {
          lastPost = Date.now();
          postUpdate(latitude, longitude, instMps);
        }
      }, err => showStatus('GPS error: ' + err.message, false), {
        enableHighAccuracy: true,
        maximumAge: 1000
      });
      saveFields();
    };

    // Clear saved fields
    btnClear.onclick = () => { localStorage.removeItem(LS_KEY); showStatus('Saved fields cleared'); };
  </script>
</body>
</html>
