<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bus Location Sender</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background:#f5f7fa; color:#111; }
    header { background:#0078ff; color:#fff; padding:10px 16px; font-size:1.1rem; font-weight:600; }
    main { padding:14px; max-width:780px; margin: 0 auto; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .row-3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
    label { font-weight:600; margin-top:10px; display:block; }
    input, select, button {
      width:100%; font-size:1rem; padding:8px 10px; border-radius:8px; border:1px solid #c9d3e0; box-sizing:border-box; margin-top:6px;
      background:#fff;
    }
    button { cursor:pointer; }
    button.primary { background:#0078ff; color:#fff; border:none; }
    button.secondary { background:#eef3f8; color:#111; border:1px solid #c9d3e0; }
    button:hover { filter: brightness(0.95); }
    input:disabled, select:disabled, button:disabled { opacity:.6; pointer-events:none; }
    #map { height:320px; border-radius:10px; margin-top:14px; }
    .status { margin-top:10px; font-size:0.95rem; }
    .ok { color: #137333; } .err { color: #b3261e; }
    .toolbar { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .hint { font-size: 0.9rem; opacity: .8; }

    .tracking-banner {
      position:fixed; left:50%; bottom:16px; transform:translateX(-50%);
      background:#111; color:#fff; padding:10px 14px; border-radius:999px;
      box-shadow:0 8px 24px rgba(0,0,0,.25);
      display:none; z-index:9999; font-size:.95rem;
    }
    .tracking-dot {
      display:inline-block; width:10px; height:10px; border-radius:50%; background:#22c55e; margin-right:8px;
      box-shadow:0 0 0 0 rgba(34,197,94,.7); animation:pulse 1.5s infinite; vertical-align:middle;
    }
    @keyframes pulse {
      0% { box-shadow:0 0 0 0 rgba(34,197,94,.7); }
      70% { box-shadow:0 0 0 12px rgba(34,197,94,0); }
      100% { box-shadow:0 0 0 0 rgba(34,197,94,0); }
    }
  </style>
</head>
<body>
  <header>üöå Bus Location Sender</header>
  <main>
    <div class="row">
      <div>
        <label for="busId">Bus ID</label>
        <input type="text" id="busId" placeholder="e.g. 201, 206, 305" />
      </div>
      <div>
        <label for="driver">Driver Name</label>
        <input type="text" id="driver" placeholder="e.g. Najmi" />
      </div>
    </div>

    <div class="row">
      <div>
        <label for="destination">Destination</label>
        <input type="text" id="destination" placeholder="e.g. Kuantan" />
      </div>
      <div>
        <label for="interval">Auto interval (sec)</label>
        <select id="interval">
          <option value="3">3</option>
          <option value="5" selected>5</option>
          <option value="10">10</option>
          <option value="15">15</option>
        </select>
      </div>
    </div>

    <div class="row-3">
      <div>
        <label for="speed">Speed (m/s)</label>
        <input type="number" id="speed" step="0.1" disabled />
      </div>
      <div>
        <label for="avgSpeed">Avg Speed (m/s)</label>
        <input type="number" id="avgSpeed" step="0.1" disabled />
      </div>
      <div>
        <label for="distance">Distance (m)</label>
        <input type="number" id="distance" step="1" disabled />
      </div>
    </div>

    <div class="toolbar">
      <button id="btnAuto" class="primary">‚ñ∂Ô∏è Start Auto Update</button>
      <button id="btnClear" class="secondary">üßπ Clear Saved Fields</button>
    </div>

    <div id="map"></div>

    <div class="status" id="status"></div>
    <p class="hint" id="hint">
      This page posts to your Apps Script endpoint. Each bus ID will be stored in its own sheet.
    </p>
  </main>

  <div id="trackingBanner" class="tracking-banner">
    <span class="tracking-dot"></span> Tracking Active ‚Äî fields locked
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // --------- CONFIG ---------
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyuInv2pTegro2wfqdMOHX1-dUKq2SY98QpP-Cm5iqFEPmHPd8kHnYv0deGQknViQSM/exec";
    const TRAIL_MAX_POINTS = 1000;
    const LS_KEY = 'bus_sender_fields';

    // --------- DOM ---------
    const busIdEl = document.getElementById('busId');
    const driverEl = document.getElementById('driver');
    const destEl   = document.getElementById('destination');
    const intervalEl = document.getElementById('interval');

    const speedEl = document.getElementById('speed');
    const avgSpeedEl = document.getElementById('avgSpeed');
    const distanceEl = document.getElementById('distance');

    const statusDiv = document.getElementById('status');
    const btnAuto = document.getElementById('btnAuto');
    const btnClear = document.getElementById('btnClear');
    const banner = document.getElementById('trackingBanner');

    // --------- Map ---------
    const map = L.map('map').setView([3.54, 103.43], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: false }).addTo(map);
    const marker = L.marker([3.54, 103.43]).addTo(map).bindPopup('Locating‚Ä¶');
    const trail = L.polyline([], { color:'#0078ff', weight:5, opacity:0.75 }).addTo(map);

    // --------- State for speed/avg/distance ---------
    let lastLat = null, lastLng = null, lastTime = null;
    let totalDistance = 0;
    let speedSamples = [];
    let watchId = null, lastSentAt = 0;

    // --------- Local Storage ---------
    function saveFields() {
      const data = {
        busId: busIdEl.value.trim(),
        driver: driverEl.value.trim(),
        dest: destEl.value.trim(),
        interval: intervalEl.value
      };
      localStorage.setItem(LS_KEY, JSON.stringify(data));
    }
    function loadFields() {
      try {
        const data = JSON.parse(localStorage.getItem(LS_KEY) || '{}');
        if (data.busId) busIdEl.value = data.busId;
        if (data.driver) driverEl.value = data.driver;
        if (data.dest) destEl.value = data.dest;
        if (data.interval) intervalEl.value = data.interval;
      } catch (_) {}
    }
    function clearFields() {
      localStorage.removeItem(LS_KEY);
      show('‚úÖ Saved fields cleared');
    }
    [busIdEl, driverEl, destEl, intervalEl].forEach(el => el.addEventListener('change', saveFields));

    // --------- UI helpers ---------
    function show(msg, ok = true) {
      statusDiv.textContent = msg;
      statusDiv.className = ok ? 'status ok' : 'status err';
    }
    function lockUI(lock) {
      [busIdEl, driverEl, destEl, intervalEl, btnClear].forEach(el => el.disabled = lock);
      banner.style.display = lock ? 'block' : 'none';
    }
    function addToTrail(lat, lng) {
      const pts = trail.getLatLngs();
      pts.push([lat, lng]);
      if (pts.length > TRAIL_MAX_POINTS) pts.splice(0, pts.length - TRAIL_MAX_POINTS);
      trail.setLatLngs(pts);
    }

    // --------- Haversine (meters) ---------
    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const toRad = d => d * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2
              + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function calculateSpeed(lat, lng) {
      if (lastLat === null) {
        lastLat = lat; lastLng = lng; lastTime = Date.now();
        return 0;
      }
      const dist = haversine(lastLat, lastLng, lat, lng);
      const now = Date.now();
      const dt = (now - lastTime) / 1000;
      const speed = dt > 0 ? dist / dt : 0;
      totalDistance += dist;
      speedSamples.push(speed);
      lastLat = lat; lastLng = lng; lastTime = now;
      return speed;
    }

    function updateStatsDisplay(currentSpeed) {
      const avg = speedSamples.length
        ? (speedSamples.reduce((a,b)=>a+b,0) / speedSamples.length)
        : 0;
      speedEl.value = currentSpeed.toFixed(2);
      avgSpeedEl.value = avg.toFixed(2);
      distanceEl.value = totalDistance.toFixed(1);
    }

    // --------- Wake Lock ---------
    let wakeLock = null;
    async function acquireWakeLock() {
      try {
        if ('wakeLock' in navigator) {
          wakeLock = await navigator.wakeLock.request('screen');
          wakeLock.addEventListener('release', () => console.log('WakeLock released'));
          document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
              wakeLock = await navigator.wakeLock.request('screen');
            }
          });
        }
      } catch (e) { console.warn('WakeLock failed:', e); }
    }

    // --------- Network ---------
    async function postUpdate(lat, lng, speed) {
      const payload = {
        busId: busIdEl.value.trim(),
        timestamp: new Date().toISOString(),
        lat, lng,
        destination: destEl.value.trim(),
        driver: driverEl.value.trim(),
        speed_mps: speed
      };
      if (!payload.busId) return show('‚ùå Enter Bus ID', false);
      if (!payload.driver) return show('‚ùå Enter Driver Name', false);

      try {
        const res = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' }, // avoid CORS preflight
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data.ok) {
          show(`‚úÖ Sent ${payload.busId} @ ${lat.toFixed(5)}, ${lng.toFixed(5)} (${speed.toFixed(2)} m/s)`);
        } else {
          show('‚ùå Error: ' + (data.error || 'Unknown'), false);
        }
      } catch (e) {
        show('‚ùå Network error: ' + e.message, false);
      }
    }

    // --------- Tracking ---------
    btnAuto.onclick = () => {
      const running = !!watchId;
      if (running) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
        lockUI(false);
        btnAuto.textContent = '‚ñ∂Ô∏è Start Auto Update';
        show('‚è∏Ô∏è Auto update stopped');
        return;
      }

      if (!navigator.geolocation) return show('‚ùå Geolocation not supported', false);
      const minGapMs = Number(intervalEl.value) * 1000;
      lastLat = lastLng = lastTime = null;
      totalDistance = 0; speedSamples = [];
      show('‚ñ∂Ô∏è Auto update started');
      btnAuto.textContent = 'üõë Stop Auto Update';
      lockUI(true);
      saveFields();
      acquireWakeLock();

      watchId = navigator.geolocation.watchPosition(pos => {
        const { latitude, longitude } = pos.coords;
        const speed = calculateSpeed(latitude, longitude);
        updateStatsDisplay(speed);

        marker.setLatLng([latitude, longitude]);
        addToTrail(latitude, longitude);

        const now = Date.now();
        if (now - lastSentAt >= minGapMs) {
          lastSentAt = now;
          postUpdate(latitude, longitude, speed);
        }
      }, err => show('‚ùå ' + err.message, false), {
        enableHighAccuracy: true,
        maximumAge: 1000
      });
    };

    // --------- Clear saved ---------
    btnClear.onclick = () => clearFields();

    // --------- Boot ---------
    loadFields();
  </script>
</body>
</html>
